"use strict";var e=require("../index.js");class t{constructor(){this._isLoaded=!1,this.sdkInstance=null,this.activeUI=null,this.eventEmitter=new e.EventEmitter,this.logger=new e.Logger("info",!0)}get isLoaded(){return this._isLoaded}mapEvent(e){if(!e||"object"!=typeof e)return null;const t=e;return{type:String(t.type||"unknown"),data:t.data||t,timestamp:new Date}}destroy(){this.activeUI&&(this.activeUI.destroy(),this.activeUI=null),this.sdkInstance&&(this.cleanupSDK(),this.sdkInstance=null),this.eventEmitter&&this.eventEmitter.removeAllListeners(),this._isLoaded=!1,this.logger.info(`${this.name} provider destroyed`)}async loadScript(t,s){return new Promise((o,i)=>{if(s&&window[s])return this.logger.info(`${this.name} SDK already loaded`),void o();const r=document.createElement("script");r.src=t,r.async=!0,r.crossOrigin="anonymous",r.onload=()=>{this.logger.info(`${this.name} SDK loaded successfully`),o()},r.onerror=s=>{this.logger.error(`Failed to load ${this.name} SDK`,s),i(new e.VecuError("PROVIDER_SDK_LOAD_FAILED",`Failed to load ${this.name} SDK from ${t}`))},document.head.appendChild(r)})}createUIContainer(e,t){const s=document.createElement("div");return s.className=`vecu-idv-${this.name}-container vecu-idv-${t}`,s.setAttribute("data-provider",this.name),s.style.cssText=`\n      position: ${"modal"===t?"fixed":"relative"};\n      width: 100%;\n      height: 100%;\n      ${"modal"===t?"top: 0; left: 0; z-index: 9999;":""}\n    `,e.appendChild(s),s}removeUIContainer(e){e&&e.parentNode&&e.parentNode.removeChild(e)}emitProviderEvent(e,t){const s={type:e,data:t,timestamp:new Date};this.eventEmitter.emit(e,s),this.eventEmitter.emit("provider:event",s)}handleProviderError(t,s){const o=t instanceof e.VecuError?t:new e.VecuError("PROVIDER_ERROR",`${this.name} provider error in ${s}: ${t instanceof Error?t.message:String(t)}`,this.name);throw this.logger.error(`${this.name} provider error`,o),this.emitProviderEvent("provider:error",{code:o.code,message:o.message,provider:this.name,context:s}),o}on(e,t){this.eventEmitter.on(e,t)}off(e,t){this.eventEmitter.off(e,t)}validateInitOptions(t){if(!t.sessionId)throw new e.VecuError("INVALID_OPTIONS","Session ID is required");if(!t.token)throw new e.VecuError("INVALID_OPTIONS","Token is required");if(!(t.container&&t.container instanceof HTMLElement))throw new e.VecuError("INVALID_OPTIONS","Valid HTML container element is required");if(!["modal","embedded"].includes(t.mode))throw new e.VecuError("INVALID_OPTIONS",'Mode must be either "modal" or "embedded"')}}const s={socure:{scriptUrl:"https://websdk.socure.com/bundle.js",supportedFeatures:["document_verification","liveness_check","face_match","address_verification","database_check","qr_code_handoff"]}},o="ready",i="start",r="complete",n="error",a="close",c="document:front:capture",d="document:back:capture",u="document:processing",l="liveness:start",m="liveness:processing",h="liveness:complete";function p(e,t){return new Promise((s,o)=>{const i=function(e,t){const s=document.createElement(e);return t&&Object.entries(t).forEach(([e,t])=>{"className"===e?s.className=t:"style"===e?s.setAttribute("style",t):e.startsWith("data-")?s.setAttribute(e,t):s[e]=t}),s}("script",{src:e,async:"true",...t});i.onload=()=>s(),i.onerror=()=>o(new Error(`Failed to load script: ${e}`)),document.head.appendChild(i)})}class v{constructor(){this.loadPromise=null,this.sdkInstance=null,this.isDestroyed=!1}static getInstance(){return v.instance||(v.instance=new v),v.instance}async load(){if((this.isDestroyed||!this.sdkInstance&&window.SocureDocVSDK)&&(this.isDestroyed=!1,this.sdkInstance=null,this.loadPromise=null,delete window.SocureDocVSDK),this.sdkInstance)return this.sdkInstance;if(this.loadPromise)return this.loadPromise;this.loadPromise=this.loadSDK();try{return this.sdkInstance=await this.loadPromise,this.sdkInstance}catch(e){throw this.loadPromise=null,e}}async loadSDK(){const t=s.socure,o="SocureDocVSDK";if(window[o])return window[o];const i=3e4,r=new Promise((t,s)=>{setTimeout(()=>{s(new e.TimeoutError("Socure SDK load timeout after 30000ms",i))},i)}),n=p(this.isDestroyed?`${t.scriptUrl}?t=${Date.now()}`:t.scriptUrl,{"data-provider":"socure",crossorigin:"anonymous"}).then(()=>new Promise((e,t)=>{setTimeout(()=>{const s=window[o];s?e(s):t(new Error(`Socure DocV SDK not found at window.${o}`))},100)}));return Promise.race([n,r])}isLoaded(){return null!==this.sdkInstance}getSDK(){return this.sdkInstance}destroy(){this.isDestroyed=!0,window.SocureDocVSDK&&delete window.SocureDocVSDK;document.querySelectorAll('script[src*="websdk.socure.com"]').forEach(e=>{e.remove()}),this.sdkInstance=null,this.loadPromise=null,v.instance=null}}v.instance=null;class f{static mapEvent(e){if(!e||"object"!=typeof e)return null;const t=e.type;return{type:this.eventMap[t]||t,data:this.mapEventData(t,e.data),timestamp:new Date(e.timestamp||Date.now())}}static mapEventData(e,t){switch(e){case"complete":return this.mapCompleteData(t);case"error":return this.mapErrorData(t);case"document_front_capture":case"document_back_capture":return this.mapDocumentCaptureData(t);case"liveness_complete":return this.mapLivenessData(t);case"qr_code_displayed":return this.mapQRCodeData(t);default:return t}}static mapCompleteData(e){return e?{sessionId:e.referenceId,status:"completed",documentData:e.documentData?{type:e.documentData.type,number:e.documentData.documentNumber,issuingCountry:e.documentData.issuingCountry,expirationDate:e.documentData.expirationDate,firstName:e.documentData.firstName,lastName:e.documentData.lastName,dateOfBirth:e.documentData.dateOfBirth,address:e.documentData.address}:void 0,livenessData:e.livenessData?{passed:e.livenessData.passed,score:e.livenessData.score,confidence:e.livenessData.confidence}:void 0,fraudSignals:e.fraud?{overallRisk:this.mapRiskLevel(e.fraud.score),signals:e.fraud.signals.map(e=>({type:e.name,risk:e.risk,description:e.description}))}:void 0}:{}}static mapErrorData(e){return e?{code:e.code||"SOCURE_ERROR",message:e.message||"Socure verification error",details:e.details,provider:"socure"}:{code:"UNKNOWN_ERROR",message:"Unknown error occurred"}}static mapDocumentCaptureData(e){return{side:e?.side||"unknown",quality:e?.quality||"unknown",timestamp:(new Date).toISOString()}}static mapLivenessData(e){return{passed:e?.passed||!1,score:e?.score||0,confidence:e?.confidence||"low",timestamp:(new Date).toISOString()}}static mapQRCodeData(e){return{qrCodeUrl:e?.url,sessionUrl:e?.sessionUrl,expiresAt:e?.expiresAt}}static mapRiskLevel(e){return e<30?"low":e<70?"medium":"high"}static mapWebhookData(e){if(!e)return null;const t=e.documentVerification?.decision||e.selfieVerification?.decision||"review";return{sessionId:e.referenceId,provider:"socure",status:"complete"===e.status?"completed":"failed",decision:this.mapDecision(t),documentData:e.documentVerification?{type:e.documentVerification.documentType,...e.documentVerification.documentFields}:void 0,livenessData:e.selfieVerification?{passed:"accept"===e.selfieVerification.decision,score:e.selfieVerification.livenessScore,confidence:this.mapConfidence(e.selfieVerification.livenessScore)}:void 0,fraudSignals:e.fraud?{overallRisk:this.mapRiskLevel(e.fraud.score),signals:e.fraud.signals.map(e=>({type:e,risk:"medium",description:e}))}:void 0,completedAt:new Date(e.updatedAt)}}static mapDecision(e){switch(e){case"accept":return"approved";case"reject":return"declined";default:return"review"}}static mapConfidence(e){return e>=80?"high":e>=50?"medium":"low"}}f.eventMap={init:o,ready:o,start:i,document_front_capture:c,document_back_capture:d,document_processing:u,liveness_start:l,liveness_processing:m,liveness_complete:h,complete:r,error:n,close:a,qr_code_displayed:"qr_code:displayed",mobile_handoff:"mobile:handoff"};exports.SocureProvider=class extends t{getCompletionMessage(e){return e.mobileNumber?"Verification complete! Check your SMS for further instructions.":e.customerUserId?"Verification complete! Please check your email for further instructions.":"Verification completed successfully! You may now proceed."}constructor(){super(),this.name="socure",this.version="1.0.0",this.supportedFeatures=[...s.socure.supportedFeatures],this.socureDocVSDK=null,this.activeSession=null,this.sdkLoader=v.getInstance()}async loadSDK(){try{this.logger.info("Loading Socure DocV SDK..."),this.sdkLoader||(this.sdkLoader=v.getInstance()),this.socureDocVSDK=await this.sdkLoader.load(),this._isLoaded=!0,this.logger.info("Socure DocV SDK loaded successfully"),this.emitProviderEvent("provider:loaded",{provider:this.name})}catch(e){this._isLoaded=!1,this.handleProviderError(e,"loadSDK")}}async initializeVerification(t){try{if(this.validateInitOptions(t),window.SocureDocVSDK||document.querySelector('iframe[src*="socure"]')){if(this.logger.info("Detected existing Socure state, cleaning up before initialization..."),t.container instanceof HTMLElement)for(;t.container.firstChild;)t.container.removeChild(t.container.firstChild);document.querySelectorAll('iframe[src*="socure"], iframe[id*="socure"]').forEach(e=>{e.remove()});["SocureDocVSDK","Socure","socure","SOCURE"].forEach(e=>{window[e]&&delete window[e]}),document.querySelectorAll('script[src*="websdk.socure.com"]').forEach(e=>{e.remove()}),this._isLoaded=!1,this.socureDocVSDK=null,this.sdkLoader&&(this.sdkLoader.destroy(),this.sdkLoader=v.getInstance()),await new Promise(e=>setTimeout(e,300)),await this.loadSDK()}if(!this.socureDocVSDK)throw new e.ProviderError(this.name,"Socure DocV SDK not loaded");this.logger.info("Initializing Socure verification",{sessionId:t.sessionId,hasSDK:!!this.socureDocVSDK,sdkType:typeof this.socureDocVSDK,methods:this.socureDocVSDK?Object.keys(this.socureDocVSDK):[]});const s=t.config?.publicKey||t.config?.sdkKey;if(!s)throw new e.ProviderError(this.name,"Socure SDK key is required in provider config");const o=t.token;if(!o)throw new e.ProviderError(this.name,"docvTransactionToken is required");const i=this.createUIContainer(t.container,t.mode),r={onProgress:e=>{this.logger.info("Socure progress event",e),this.handleProgressEvent(e,t.sessionId)},onSuccess:e=>{if(this.logger.info("Socure verification completed",e),"status"in e&&"DOCUMENTS_UPLOADED"===e.status){const s=this.getCompletionMessage(e),o={sessionId:t.sessionId,message:s,result:{status:"completed",docvTransactionToken:e.docvTransactionToken,deviceSessionToken:e.deviceSessionToken,customerUserId:e.customerUserId}};this.emitProviderEvent("verification:completed",o)}else{const s=f.mapEvent({type:"complete",data:e,timestamp:Date.now()});s&&this.emitProviderEvent(s.type,s.data);const o={sessionId:t.sessionId,message:"Verification completed successfully! You may now proceed.",result:e};this.emitProviderEvent("verification:completed",o)}},onError:e=>{if(this.logger.error("Socure verification error",e),!("status"in e)||"CONSENT_DECLINED"!==e.status&&"DOCUMENTS_UPLOAD_FAILED"!==e.status){const s=f.mapEvent({type:"error",data:e,timestamp:Date.now()});s&&this.emitProviderEvent(s.type,s.data),"code"in e&&"USER_CANCELLED"===e.code&&this.emitProviderEvent("ui:closed",{sessionId:t.sessionId})}else{const s="CONSENT_DECLINED"===e.status?"USER_CANCELLED":"UPLOAD_FAILED";this.emitProviderEvent("verification:failed",{sessionId:t.sessionId,error:{code:s,message:e.status.replace(/_/g," ").toLowerCase(),docvTransactionToken:e.docvTransactionToken}}),"CONSENT_DECLINED"===e.status&&this.emitProviderEvent("ui:closed",{sessionId:t.sessionId})}},qrCodeNeeded:t.config?.qrCode||!1},n=`socure-container-${Date.now()}`;i.id=n;const a=`#${n}`;let c;try{c=this.socureDocVSDK.launch(s,o,a,r)}catch(e){throw e}this.activeSession=c&&"object"==typeof c?c:{id:t.sessionId,status:"active",destroy:()=>{this.logger.info("Destroying Socure session")}},setTimeout(()=>{document.querySelector(a)},500);const d={container:i,sessionId:t.sessionId,provider:this.name,destroy:()=>{this.destroySession(),this.removeUIContainer(i)}};return this.activeUI=d,this.emitProviderEvent("ui:created",{sessionId:t.sessionId}),setTimeout(()=>{this.emitProviderEvent("ui:ready",{sessionId:t.sessionId})},100),d}catch(e){this.handleProviderError(e,"initializeVerification")}}processWebhookData(t){try{const e=f.mapWebhookData(t);return{status:e.status,decision:e.decision,data:{documentData:e.documentData,livenessData:e.livenessData,fraudSignals:e.fraudSignals},metadata:{provider:this.name,processedAt:(new Date).toISOString()}}}catch(t){throw this.logger.error("Failed to process webhook data",t),new e.ProviderError(this.name,"Failed to process webhook data")}}mapEvent(e){return f.mapEvent(e)}cleanupSDK(){this.destroySession();document.querySelectorAll('iframe[src*="socure"], iframe[id*="socure"]').forEach(e=>{this.logger.info("Removing Socure iframe from DOM"),e.remove()});["SocureDocVSDK","Socure","socure","SOCURE"].forEach(e=>{window[e]&&(this.logger.info(`Clearing global ${e}`),delete window[e])});document.querySelectorAll('[id*="socure-container"], .socure-sdk-container').forEach(e=>{this.logger.info("Removing Socure container from DOM"),e.remove()}),this.sdkLoader.destroy(),this.socureDocVSDK=null}handleProgressEvent(e,t){if(e.status){const s={WAITING_FOR_USER_TO_REDIRECT:"qr_code_displayed",WAITING_FOR_UPLOAD:"verification:started"}[e.status]||"verification:progress";this.emitProviderEvent(s,{sessionId:t,status:e.status,docvTransactionToken:e.docvTransactionToken,customerUserId:e.customerUserId,mobileNumber:e.mobileNumber}),this.emitProviderEvent("verification:progress",{sessionId:t,step:e.status,percentage:"WAITING_FOR_USER_TO_REDIRECT"===e.status?10:30,message:e.status.replace(/_/g," ").toLowerCase()})}else this.logger.warn("Received unexpected progress event structure from Socure",e)}destroySession(){if(this.activeSession){try{this.activeSession.destroy()}catch(e){this.logger.error("Error destroying Socure session",e)}this.activeSession=null}}};
//# sourceMappingURL=SocureProvider-C--YPLK4.js.map
