import{EventEmitter as e,Logger as t,VecuError as s,TimeoutError as i,ProviderError as n}from"../index.esm.js";class r{constructor(){this._isLoaded=!1,this.sdkInstance=null,this.activeUI=null,this.eventEmitter=new e,this.logger=new t("info",!0)}get isLoaded(){return this._isLoaded}mapEvent(e){if(!e||"object"!=typeof e)return null;const t=e;return{type:String(t.type||"unknown"),data:t.data||t,timestamp:new Date}}destroy(){this.activeUI&&(this.activeUI.destroy(),this.activeUI=null),this.sdkInstance&&(this.cleanupSDK(),this.sdkInstance=null),this.eventEmitter&&this.eventEmitter.removeAllListeners(),this._isLoaded=!1,this.logger.info(`${this.name} provider destroyed`)}async loadScript(e,t){return new Promise((i,n)=>{if(t&&window[t])return this.logger.info(`${this.name} SDK already loaded`),void i();const r=document.createElement("script");r.src=e,r.async=!0,r.crossOrigin="anonymous",r.onload=()=>{this.logger.info(`${this.name} SDK loaded successfully`),i()},r.onerror=t=>{this.logger.error(`Failed to load ${this.name} SDK`,t),n(new s("PROVIDER_SDK_LOAD_FAILED",`Failed to load ${this.name} SDK from ${e}`))},document.head.appendChild(r)})}createUIContainer(e,t){const s=document.createElement("div");return s.className=`vecu-idv-${this.name}-container vecu-idv-${t}`,s.setAttribute("data-provider",this.name),s.style.cssText=`\n      position: ${"modal"===t?"fixed":"relative"};\n      width: 100%;\n      height: 100%;\n      ${"modal"===t?"top: 0; left: 0; z-index: 9999;":""}\n    `,e.appendChild(s),s}removeUIContainer(e){e&&e.parentNode&&e.parentNode.removeChild(e)}emitProviderEvent(e,t){const s={type:e,data:t,timestamp:new Date};this.eventEmitter.emit(e,s),this.eventEmitter.emit("provider:event",s)}handleProviderError(e,t){const i=e instanceof s?e:new s("PROVIDER_ERROR",`${this.name} provider error in ${t}: ${e instanceof Error?e.message:String(e)}`,this.name);throw this.logger.error(`${this.name} provider error`,i),this.emitProviderEvent("provider:error",{code:i.code,message:i.message,provider:this.name,context:t}),i}on(e,t){this.eventEmitter.on(e,t)}off(e,t){this.eventEmitter.off(e,t)}validateInitOptions(e){if(!e.sessionId)throw new s("INVALID_OPTIONS","Session ID is required");if(!e.token)throw new s("INVALID_OPTIONS","Token is required");if(!(e.container&&e.container instanceof HTMLElement))throw new s("INVALID_OPTIONS","Valid HTML container element is required");if(!["modal","embedded"].includes(e.mode))throw new s("INVALID_OPTIONS",'Mode must be either "modal" or "embedded"')}}const o={socure:{scriptUrl:"https://websdk.socure.com/bundle.js",globalVariableName:"SocureSDK",supportedFeatures:["document_verification","liveness_check","face_match","address_verification","database_check","qr_code_handoff"]}},a="ready",d="start",c="complete",l="error",u="close",m="document:front:capture",h="document:back:capture",p="document:processing",v="liveness:start",f="liveness:processing",D="liveness:complete";function g(e,t){return new Promise((s,i)=>{const n=function(e,t){const s=document.createElement(e);return t&&Object.entries(t).forEach(([e,t])=>{"className"===e?s.className=t:"style"===e?s.setAttribute("style",t):e.startsWith("data-")?s.setAttribute(e,t):s[e]=t}),s}("script",{src:e,async:"true",...t});n.onload=()=>s(),n.onerror=()=>i(new Error(`Failed to load script: ${e}`)),document.head.appendChild(n)})}class S{constructor(){this.loadPromise=null,this.sdkInstance=null}static getInstance(){return S.instance||(S.instance=new S),S.instance}async load(){if(this.sdkInstance)return this.sdkInstance;if(this.loadPromise)return this.loadPromise;this.loadPromise=this.loadSDK();try{return this.sdkInstance=await this.loadPromise,this.sdkInstance}catch(e){throw this.loadPromise=null,e}}async loadSDK(){const e=o.socure,t=e.globalVariableName;if(window[t])return window[t];const s=3e4,n=new Promise((e,t)=>{setTimeout(()=>{t(new i("Socure SDK load timeout after 30000ms",s))},s)}),r=g(e.scriptUrl,{"data-provider":"socure",crossorigin:"anonymous"}).then(()=>{const e=window[t];if(!e)throw new Error(`Socure SDK not found at window.${t}`);return e});return Promise.race([r,n])}isLoaded(){return null!==this.sdkInstance}getSDK(){return this.sdkInstance}destroy(){this.sdkInstance&&"function"==typeof this.sdkInstance.destroy&&this.sdkInstance.destroy(),this.sdkInstance=null,this.loadPromise=null}}S.instance=null;class w{static mapEvent(e){if(!e||"object"!=typeof e)return null;const t=e.type;return{type:this.eventMap[t]||t,data:this.mapEventData(t,e.data),timestamp:new Date(e.timestamp||Date.now())}}static mapEventData(e,t){switch(e){case"complete":return this.mapCompleteData(t);case"error":return this.mapErrorData(t);case"document_front_capture":case"document_back_capture":return this.mapDocumentCaptureData(t);case"liveness_complete":return this.mapLivenessData(t);case"qr_code_displayed":return this.mapQRCodeData(t);default:return t}}static mapCompleteData(e){return e?{sessionId:e.referenceId,status:"completed",documentData:e.documentData?{type:e.documentData.type,number:e.documentData.documentNumber,issuingCountry:e.documentData.issuingCountry,expirationDate:e.documentData.expirationDate,firstName:e.documentData.firstName,lastName:e.documentData.lastName,dateOfBirth:e.documentData.dateOfBirth,address:e.documentData.address}:void 0,livenessData:e.livenessData?{passed:e.livenessData.passed,score:e.livenessData.score,confidence:e.livenessData.confidence}:void 0,fraudSignals:e.fraud?{overallRisk:this.mapRiskLevel(e.fraud.score),signals:e.fraud.signals.map(e=>({type:e.name,risk:e.risk,description:e.description}))}:void 0}:{}}static mapErrorData(e){return e?{code:e.code||"SOCURE_ERROR",message:e.message||"Socure verification error",details:e.details,provider:"socure"}:{code:"UNKNOWN_ERROR",message:"Unknown error occurred"}}static mapDocumentCaptureData(e){return{side:e?.side||"unknown",quality:e?.quality||"unknown",timestamp:(new Date).toISOString()}}static mapLivenessData(e){return{passed:e?.passed||!1,score:e?.score||0,confidence:e?.confidence||"low",timestamp:(new Date).toISOString()}}static mapQRCodeData(e){return{qrCodeUrl:e?.url,sessionUrl:e?.sessionUrl,expiresAt:e?.expiresAt}}static mapRiskLevel(e){return e<30?"low":e<70?"medium":"high"}static mapWebhookData(e){if(!e)return null;const t=e.documentVerification?.decision||e.selfieVerification?.decision||"review";return{sessionId:e.referenceId,provider:"socure",status:"complete"===e.status?"completed":"failed",decision:this.mapDecision(t),documentData:e.documentVerification?{type:e.documentVerification.documentType,...e.documentVerification.documentFields}:void 0,livenessData:e.selfieVerification?{passed:"accept"===e.selfieVerification.decision,score:e.selfieVerification.livenessScore,confidence:this.mapConfidence(e.selfieVerification.livenessScore)}:void 0,fraudSignals:e.fraud?{overallRisk:this.mapRiskLevel(e.fraud.score),signals:e.fraud.signals.map(e=>({type:e,risk:"medium",description:e}))}:void 0,completedAt:new Date(e.updatedAt)}}static mapDecision(e){switch(e){case"accept":return"approved";case"reject":return"declined";default:return"review"}}static mapConfidence(e){return e>=80?"high":e>=50?"medium":"low"}}w.eventMap={init:a,ready:a,start:d,document_front_capture:m,document_back_capture:h,document_processing:p,liveness_start:v,liveness_processing:f,liveness_complete:D,complete:c,error:l,close:u,qr_code_displayed:"qr_code:displayed",mobile_handoff:"mobile:handoff"};class y extends r{constructor(){super(),this.name="socure",this.version="1.0.0",this.supportedFeatures=[...o.socure.supportedFeatures],this.socureSDK=null,this.activeSession=null,this.eventHandlers=new Map,this.sdkLoader=S.getInstance()}async loadSDK(){try{this.logger.info("Loading Socure SDK..."),this.socureSDK=await this.sdkLoader.load(),this._isLoaded=!0,this.logger.info("Socure SDK loaded successfully"),this.emitProviderEvent("provider:loaded",{provider:this.name})}catch(e){this.handleProviderError(e,"loadSDK")}}async initializeVerification(e){try{if(this.validateInitOptions(e),!this.socureSDK)throw new n(this.name,"Socure SDK not loaded");this.logger.info("Initializing Socure verification",{sessionId:e.sessionId});const t={publicKey:e.config?.publicKey||"",environment:e.config?.environment||"production",flow:e.config?.flow,qrCode:e.config?.qrCode||!1,language:e.language,theme:e.theme};await this.socureSDK.init(t);const s=this.createUIContainer(e.container,e.mode);this.setupEventListeners();const i=await this.socureSDK.createSession({sessionToken:e.token,container:s,onReady:()=>{this.logger.info("Socure UI ready"),this.emitProviderEvent("ui:ready",{sessionId:e.sessionId})},onComplete:e=>{this.logger.info("Socure verification completed",e);const t=w.mapEvent({type:"complete",data:e,timestamp:Date.now()});t&&this.emitProviderEvent(t.type,t.data)},onError:e=>{this.logger.error("Socure verification error",e);const t=w.mapEvent({type:"error",data:e,timestamp:Date.now()});t&&this.emitProviderEvent(t.type,t.data)},onClose:()=>{this.logger.info("Socure UI closed"),this.emitProviderEvent("ui:closed",{sessionId:e.sessionId})}});this.activeSession=i;const r={container:s,sessionId:e.sessionId,provider:this.name,destroy:()=>{this.destroySession(),this.removeUIContainer(s)}};return this.activeUI=r,this.emitProviderEvent("ui:created",{sessionId:e.sessionId}),r}catch(e){this.handleProviderError(e,"initializeVerification")}}processWebhookData(e){try{const t=w.mapWebhookData(e);return{status:t.status,decision:t.decision,data:{documentData:t.documentData,livenessData:t.livenessData,fraudSignals:t.fraudSignals},metadata:{provider:this.name,processedAt:(new Date).toISOString()}}}catch(e){throw this.logger.error("Failed to process webhook data",e),new n(this.name,"Failed to process webhook data")}}mapEvent(e){return w.mapEvent(e)}cleanupSDK(){this.destroySession(),this.removeEventListeners(),this.sdkLoader.destroy(),this.socureSDK=null}setupEventListeners(){if(!this.socureSDK)return;[{socureEvent:"document_front_capture",handler:e=>this.handleSocureEvent({type:"document_front_capture",data:e,timestamp:Date.now()})},{socureEvent:"document_back_capture",handler:e=>this.handleSocureEvent({type:"document_back_capture",data:e,timestamp:Date.now()})},{socureEvent:"document_processing",handler:e=>this.handleSocureEvent({type:"document_processing",data:e,timestamp:Date.now()})},{socureEvent:"liveness_start",handler:e=>this.handleSocureEvent({type:"liveness_start",data:e,timestamp:Date.now()})},{socureEvent:"liveness_processing",handler:e=>this.handleSocureEvent({type:"liveness_processing",data:e,timestamp:Date.now()})},{socureEvent:"liveness_complete",handler:e=>this.handleSocureEvent({type:"liveness_complete",data:e,timestamp:Date.now()})},{socureEvent:"qr_code_displayed",handler:e=>this.handleSocureEvent({type:"qr_code_displayed",data:e,timestamp:Date.now()})},{socureEvent:"mobile_handoff",handler:e=>this.handleSocureEvent({type:"mobile_handoff",data:e,timestamp:Date.now()})}].forEach(({socureEvent:e,handler:t})=>{this.socureSDK.on(e,t),this.eventHandlers.has(e)||this.eventHandlers.set(e,new Set),this.eventHandlers.get(e).add(t)})}removeEventListeners(){this.socureSDK&&(this.eventHandlers.forEach((e,t)=>{e.forEach(e=>{this.socureSDK.off(t,e)})}),this.eventHandlers.clear())}handleSocureEvent(e){const t=this.mapEvent(e);t&&this.emitProviderEvent(t.type,t.data)}destroySession(){if(this.activeSession){try{this.activeSession.destroy()}catch(e){this.logger.error("Error destroying Socure session",e)}this.activeSession=null}}}export{y as SocureProvider};
//# sourceMappingURL=SocureProvider-BUYjlFte.esm.js.map
